<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where is my $ - doodozz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { padding-bottom: 100px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .main-title { letter-spacing: -0.02em; font-size: 1.75rem; line-height: 1.2; }
        .doodozz-sig { letter-spacing: 0.35em; font-size: 10px; color: #94a3b8; font-weight: 800; text-indent: 0.35em; }
        .nav-text { font-size: 13px !important; letter-spacing: 1px !important; margin-top: 4px; }
        [v-cloak] { display: none; }
        
        /* çµ±ä¸€æŒ‰éˆ•å¤§å°ï¼Œé¿å…èª¤è§¸ */
        .action-btn { 
            width: 36px; 
            height: 36px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .action-btn:active { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative">
        
        <header class="p-8 border-b bg-white sticky top-0 z-20 text-center">
            <h1 class="main-title font-black text-slate-800 uppercase">Where is my $</h1>
            <p class="doodozz-sig mt-2 uppercase text-blue-400/70">Designed by doodozz</p>
        </header>

        <main class="p-4">
            <div v-if="currentTab === 'asset'">
                <section class="mb-6 text-center">
                    <p class="text-xs text-gray-400 mb-2 font-black uppercase tracking-[0.2em]">ç¸½è³‡ç”¢æ·¨å€¼</p>
                    <div class="bg-slate-900 p-8 rounded-[2rem] text-white shadow-xl">
                        <p class="text-4xl font-black">${{ Math.round(grandTotal).toLocaleString() }}</p>
                    </div>
                </section>

                <div class="space-y-3">
                    <div class="p-4 bg-white border border-slate-100 rounded-2xl flex justify-between items-center card-shadow">
                        <span class="font-bold text-slate-500">ğŸ‡¹ğŸ‡¼ å°è‚¡ç¸½å¸‚å€¼</span>
                        <span class="font-black text-slate-800">${{ Math.round(totalTWValue).toLocaleString() }}</span>
                    </div>
                    <div class="p-4 bg-white border border-slate-100 rounded-2xl flex justify-between items-center card-shadow">
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-500">ğŸ‡ºğŸ‡¸ ç¾è‚¡ç¸½å¸‚å€¼</span>
                            <span class="text-[10px] text-gray-400 font-medium">åŒ¯ç‡: {{ exchangeRate }}</span>
                        </div>
                        <span class="font-black text-slate-800">${{ Math.round(totalUSValueInTWD).toLocaleString() }}</span>
                    </div>
                    <div class="p-4 bg-emerald-50 border border-emerald-100 rounded-2xl card-shadow">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-emerald-800 text-sm">ğŸ›¡ï¸ é å‚™é‡‘</span>
                            <button @click="manualReserve = totalReserve" class="text-[10px] bg-emerald-200 text-emerald-700 px-3 py-1 rounded-lg font-black">åŒæ­¥è¨ˆç®—</button>
                        </div>
                        <div class="flex items-center">
                            <span class="text-emerald-700 mr-2 font-black">$</span>
                            <input v-model.number="manualReserve" type="number" class="w-full bg-transparent border-b border-emerald-200 focus:border-emerald-500 outline-none font-black text-emerald-900 text-xl">
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                        <h3 class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">å…¶ä»–è³‡ç”¢</h3>
                        <div class="space-y-2 mb-4">
                            <div v-for="m in manualAssets" :key="m.id" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm">
                                <span class="text-slate-500 font-bold text-sm">{{ m.name }}</span>
                                <div class="flex items-center gap-3">
                                    <span class="font-black text-slate-800 text-sm">${{ Math.round(m.amount).toLocaleString() }}</span>
                                    <button @click="openManualEdit(m)" class="text-slate-300">âœ</button>
                                    <button @click="deleteManualAsset(m.id)" class="text-red-200">âœ•</button>
                                </div>
                            </div>
                        </div>
                        <button @click="openManualAdd" class="w-full bg-slate-800 text-white py-2 rounded-xl font-bold text-sm">æ–°å¢é …ç›®</button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'position'">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-xl">
                        <button v-for="m in ['å°è‚¡', 'ç¾è‚¡']" @click="market = m" :class="['px-5 py-1.5 rounded-lg text-sm font-bold transition', market === m ? 'bg-white shadow-sm text-blue-600' : 'text-gray-400']">{{ m }}</button>
                    </div>
                    <div v-if="market === 'ç¾è‚¡'" class="flex items-center gap-2">
                        <div class="flex items-center bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100">
                            <span class="text-[10px] text-indigo-400 mr-1 font-bold">åŒ¯ç‡</span>
                            <input v-model.number="exchangeRate" type="number" step="0.01" class="w-10 bg-transparent text-xs font-bold text-indigo-700 outline-none">
                        </div>
                        <button @click="usdMode = !usdMode" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-black shadow-md">
                            {{ usdMode ? 'USD' : 'TWD' }}
                        </button>
                    </div>
                </div>

                <div class="bg-blue-600 rounded-3xl p-6 mb-6 text-white shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-xs font-black opacity-80 uppercase tracking-widest mb-1">{{ market }}ç•¶å‰å¸‚å€¼ ({{currentCurrencyLabel}})</p>
                        <h2 class="text-3xl font-black mb-4">{{ formatMarketTotal() }}</h2>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[14px] font-black opacity-80 uppercase tracking-widest mb-1">å¹³å‡æç›Š</p>
                                <p class="text-xl font-black" :class="marketStats.profit >= 0 ? 'text-red-300' : 'text-green-300'">
                                    {{ marketStats.profit >= 0 ? '+' : '' }}{{ marketStats.profit.toFixed(2) }}%
                                </p>
                            </div>
                            <div>
                                <p class="text-[14px] font-black opacity-80 uppercase tracking-widest mb-1 text-right">ä½”ç¸½æŒè‚¡</p>
                                <p class="text-xl font-black text-right">{{ marketStats.ratio.toFixed(1) }}%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="stock in filteredStocks" :key="stock.id" class="border border-slate-100 rounded-3xl p-5 bg-white card-shadow relative">
                        <div class="absolute top-4 right-4 flex gap-2">
                            <a :href="'https://www.google.com/search?q=' + (market==='å°è‚¡'?'TPE:':'') + stock.symbol + '+stock'" target="_blank" class="action-btn text-blue-400 text-xl">ğŸ”</a>
                            <button @click="openEditModal(stock)" class="action-btn text-slate-300 text-xl">âœ</button>
                            <button @click="removeStock(stock)" class="action-btn text-red-100 text-xl">âœ•</button>
                        </div>
                        
                        <div class="mb-4 pr-24">
                            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-tighter">{{ stock.isSIP ? 'ğŸš€ å®šæœŸå®šé¡' : 'ğŸ“¦ å€‹è‚¡æŒå€‰' }}</span>
                            <h3 class="font-black text-xl text-slate-800 truncate">{{ stock.name }} <span class="text-xs text-slate-300 font-normal">({{ stock.symbol }})</span></h3>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <div class="bg-slate-50 p-3 rounded-2xl text-center">
                                <p class="text-[10px] text-gray-400 font-bold mb-1">å¸‚å€¼ ({{ currentCurrencyLabel }})</p>
                                <p class="font-black text-slate-700 text-sm">{{ formatStockValue(stock) }}</p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-2xl text-center">
                                <p class="text-[10px] text-gray-400 font-bold mb-1">ä½”æ¯”</p>
                                <p class="font-black text-blue-600 text-sm">{{ getRatio(stock).toFixed(1) }}%</p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-2xl text-center">
                                <p class="text-[10px] text-gray-400 font-bold mb-1">æç›Š</p>
                                <p :class="stock.currentPrice >= stock.cost ? 'text-red-500' : 'text-green-600'" class="font-black text-sm">
                                    {{ (((stock.currentPrice/stock.cost)-1)*100).toFixed(2) }}%
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal" class="w-full mt-6 py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs uppercase tracking-widest">ï¼‹ æ–°å¢æŒè‚¡ç´€éŒ„</button>
            </div>

            <div v-if="currentTab === 'profit'">
                <h2 class="text-xl font-black mb-6 border-l-8 border-orange-500 pl-3">æ™ºæ…§åœåˆ©è¨ˆç®—</h2>
                <div v-if="stocks.length === 0" class="text-center py-20 text-gray-300 font-bold text-xs tracking-widest">ç›®å‰ç„¡æŒè‚¡æ•¸æ“š</div>
                <div v-else class="space-y-6">
                    <select v-model="selectedStockIdx" class="w-full p-5 rounded-2xl border-none bg-slate-100 font-black text-slate-700 shadow-inner">
                        <option :value="null">-- é¸æ“‡è‚¡ç¥¨ --</option>
                        <option v-for="(s, i) in stocks" :key="s.id" :value="i">{{ s.name }} (ç¾åƒ¹: {{s.currentPrice}})</option>
                    </select>
                    <div v-if="selectedStockIdx !== null" class="bg-orange-50 p-8 rounded-[2.5rem] space-y-6 border border-orange-100">
                        <div v-if="stocks[selectedStockIdx].currentPrice < stocks[selectedStockIdx].cost" class="text-center py-10">
                            <p class="text-4xl mb-4 opacity-30">ğŸ“‰</p>
                            <p class="font-black text-orange-800">ç›®å‰ç‚ºè™§æç‹€æ…‹</p>
                        </div>
                        <div v-else class="space-y-6">
                            <div class="flex justify-between items-center border-b border-orange-200 pb-4">
                                <span class="font-bold text-orange-800 text-sm">å‡ºä¸€åŠå¯¦ç¾ç²åˆ©</span>
                                <span class="font-black text-red-600 text-xl">+ {{ profitCalc.realized.toLocaleString(undefined, {minimumFractionDigits: 2}) }}</span>
                            </div>
                            <div class="bg-white p-6 rounded-3xl shadow-sm text-center border border-orange-200">
                                <p class="text-[10px] text-gray-400 font-black uppercase mb-2 tracking-widest">å»ºè­°åœåˆ©åƒè€ƒåƒ¹</p>
                                <p class="text-4xl font-black text-orange-600">${{ profitCalc.stopPrice.toLocaleString(undefined, {minimumFractionDigits: 2}) }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'reserve'">
                <div class="bg-slate-900 p-6 rounded-[2rem] text-white flex justify-between items-center shadow-2xl mb-8">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">å»ºè­°é å‚™é‡‘ç¸½è¨ˆ</p>
                        <p class="text-3xl font-black">${{ Math.round(totalReserve).toLocaleString() }}</p>
                    </div>
                    <p class="text-4xl opacity-50">ğŸ›¡ï¸</p>
                </div>
                <div class="space-y-5">
                    <div class="p-6 bg-white rounded-3xl border border-slate-100 card-shadow">
                        <p class="font-black text-emerald-600 mb-6 tracking-tighter text-lg">ğŸ§± ç¬¬ä¸€å±¤ï¼šç”Ÿå­˜ç¾é‡‘</p>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-slate-400">æ¯æœˆèŠ±è²»</span>
                                <input v-model.number="monthlyEx" type="number" class="w-32 text-right p-2 border-b-2 border-emerald-50 outline-none font-black text-lg focus:border-emerald-400">
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-slate-400">é ç•™æœˆæ•¸</span>
                                <div class="flex gap-2">
                                    <button v-for="m in [6, 9]" @click="reserveMonths = m" :class="['px-4 py-1.5 rounded-xl text-xs font-black transition', reserveMonths === m ? 'bg-emerald-500 text-white' : 'bg-slate-50 text-slate-400']">{{ m }}å€‹æœˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-white rounded-3xl border border-slate-100 card-shadow">
                        <p class="font-black text-blue-600 mb-4 tracking-tighter text-lg">ğŸ§± ç¬¬äºŒå±¤ï¼šåŠ ç¢¼å„²å‚™</p>
                        <p class="text-xs text-slate-400 font-bold">ç›®å‰æ¡ç”¨ç¸½æŒè‚¡å¸‚å€¼ {{ Math.round(reserveRatio * 100) }}%</p>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-6 backdrop-blur-sm">
            <div class="bg-white w-full max-h-[90vh] overflow-y-auto rounded-[2.5rem] p-6 shadow-2xl">
                <h2 class="text-xl font-black mb-6">{{ isEditing ? 'ä¿®æ”¹' : 'æ–°å¢' }}æŒè‚¡</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input v-model="modalItem.name" placeholder="è‚¡ç¥¨åç¨±" class="p-4 bg-slate-100 rounded-2xl outline-none font-bold text-sm">
                        <input v-model="modalItem.symbol" placeholder="ä»£è™Ÿ" class="p-4 bg-slate-100 rounded-2xl outline-none font-bold text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input v-model.number="modalItem.cost" type="number" step="0.01" placeholder="åŸå§‹æˆæœ¬" class="p-4 bg-slate-100 rounded-2xl outline-none font-bold">
                        <input v-model.number="modalItem.shares" type="number" step="0.001" placeholder="ç¸½è‚¡æ•¸" class="p-4 bg-slate-100 rounded-2xl outline-none font-bold">
                    </div>
                    <input v-model.number="modalItem.currentPrice" type="number" step="0.01" placeholder="ç›®å‰ç¾åƒ¹ (å°å¹£/ç¾é‡‘)" class="w-full p-4 bg-blue-50 rounded-2xl outline-none font-bold border-2 border-blue-200">
                    
                    <div class="p-4 bg-slate-50 rounded-3xl border border-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-black text-slate-600">ğŸš€ å®šæœŸå®šé¡è¨­å®š</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="modalItem.isSIP" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                        </div>
                        <div v-if="modalItem.isSIP" class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-slate-200">
                            <input v-model.number="modalItem.sipDay" type="number" placeholder="æ‰£æ¬¾æ—¥" class="p-3 bg-white rounded-xl text-sm font-bold border border-slate-200">
                            <input v-model.number="modalItem.sipAmount" type="number" placeholder="é‡‘é¡" class="p-3 bg-white rounded-xl text-sm font-bold border border-slate-200">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="showModal = false" class="flex-1 py-4 font-bold text-slate-400">å–æ¶ˆ</button>
                    <button @click="handleModalSubmit" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black">å„²å­˜</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 max-w-md w-full bg-white/95 backdrop-blur-md border-t border-slate-100 flex justify-around py-4 z-30 shadow-lg">
            <button v-for="t in ['asset','position','profit','reserve']" @click="currentTab = t" :class="['flex flex-col items-center transition-all duration-300', currentTab === t ? 'scale-110 text-blue-600' : 'text-slate-300']">
                <span class="text-2xl mb-1">{{ {asset:'ğŸ’°', position:'ğŸ“ˆ', profit:'ğŸ¯', reserve:'ğŸ›¡ï¸'}[t] }}</span>
                <span class="nav-text font-black uppercase">{{ {asset:'ç¸½è¦½', position:'æŒè‚¡', profit:'åœåˆ©', reserve:'é å‚™'}[t] }}</span>
            </button>
        </nav>
        
        <div v-if="sipPending.length > 0" class="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[60] p-6 backdrop-blur-md">
            <div class="bg-white w-full rounded-[2.5rem] p-8 text-center shadow-2xl">
                <p class="text-4xl mb-4">ğŸ’°</p>
                <h2 class="text-xl font-black mb-2">å®šæœŸå®šé¡ç´€éŒ„</h2>
                <p class="text-sm text-gray-500 mb-6">åµæ¸¬åˆ°æ‰£æ¬¾æ—¥å·²éï¼Œè¦ç´€éŒ„æœ¬æ¬¡æŠ•è³‡å—ï¼Ÿ</p>
                <div class="space-y-2 mb-6 max-h-40 overflow-y-auto">
                    <div v-for="item in sipPending" class="bg-slate-50 p-3 rounded-xl flex justify-between text-sm font-bold">
                        <span>{{ item.name }}</span>
                        <span class="text-blue-600">${{ item.amount }}</span>
                    </div>
                </div>
                <button @click="confirmAllSIP" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black mb-2">ç¢ºèªä¸¦è‡ªå‹•æ”¤å¹³</button>
                <button @click="sipPending = []" class="w-full py-2 text-slate-300 font-bold text-xs">æš«ä¸ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;
        createApp({
            setup() {
                const currentTab = ref('asset');
                const market = ref('å°è‚¡');
                const stocks = ref([]);
                const usdMode = ref(false);
                const exchangeRate = ref(32.5);
                const showModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const sipPending = ref([]);
                const modalItem = ref({});
                const manualAssets = ref([]);
                const manualReserve = ref(0);
                const monthlyEx = ref(50000);
                const reserveMonths = ref(6);
                const reserveRatio = ref(0.1);
                const selectedStockIdx = ref(null);

                onMounted(() => {
                    const saved = localStorage.getItem('wealth-master-permanent');
                    if (saved) {
                        const d = JSON.parse(saved);
                        stocks.value = d.stocks || [];
                        manualAssets.value = d.manualAssets || [];
                        exchangeRate.value = d.exchangeRate || 32.5;
                        manualReserve.value = d.manualReserve || 0;
                        monthlyEx.value = d.monthlyEx || 50000;
                        checkSIP(d.lastCheckDate);
                    }
                });

                watch([stocks, manualAssets, exchangeRate, manualReserve, monthlyEx], () => {
                    localStorage.setItem('wealth-master-permanent', JSON.stringify({
                        stocks: stocks.value, manualAssets: manualAssets.value,
                        exchangeRate: exchangeRate.value, manualReserve: manualReserve.value,
                        monthlyEx: monthlyEx.value, lastCheckDate: new Date().toISOString()
                    }));
                }, { deep: true });

                // æ ¸å¿ƒæ›ç®—é‚è¼¯ï¼šæ¨¡å¼ A
                const currentCurrencyLabel = computed(() => (market.value === 'ç¾è‚¡' && usdMode.value) ? 'USD' : 'TWD');
                
                const formatMarketTotal = () => {
                    let total = market.value === 'å°è‚¡' ? totalTWValue.value : totalUSValueInTWD.value;
                    if (market.value === 'ç¾è‚¡' && usdMode.value) total /= exchangeRate.value;
                    return total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                };

                const formatStockValue = (s) => {
                    let val = s.currentPrice * s.shares;
                    // å¦‚æœåœ¨ç¾è‚¡é é¢ä¸”åˆ‡æ›åˆ° USD æ¨¡å¼ï¼Œä¸”åŸå§‹è¼¸å…¥æ˜¯å°å¹£ï¼ˆæˆ–è€…å¦³ç¿’æ…£ç¾è‚¡ç¾åƒ¹å°±è¼¸ç¾é‡‘ï¼Œé€™è£¡åšé‚è¼¯åˆ¤æ–·ï¼‰
                    // é€™è£¡çµ±ä¸€é‚è¼¯ï¼šç¾åƒ¹æ¬„ä½è«‹è¼¸å…¥è©²å¸‚å ´è²¨å¹£ï¼ˆå°å¹£è¼¸å°å¹£ã€ç¾é‡‘è¼¸ç¾é‡‘ï¼‰
                    if (s.market === 'ç¾è‚¡' && !usdMode.value) val *= exchangeRate.value; 
                    return val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                };

                const checkSIP = (lastCheck) => {
                    if (!lastCheck) return;
                    const now = new Date(), last = new Date(lastCheck);
                    const pending = [];
                    stocks.value.forEach(s => {
                        if (s.isSIP) {
                            let cur = new Date(last); cur.setDate(cur.getDate() + 1);
                            while (cur <= now) {
                                if (cur.getDate() === s.sipDay) pending.push({ id: s.id, name: s.name, amount: s.sipAmount, date: cur.toLocaleDateString() });
                                cur.setDate(cur.getDate() + 1);
                            }
                        }
                    });
                    sipPending.value = pending;
                };

                const confirmAllSIP = () => {
                    sipPending.value.forEach(p => {
                        const s = stocks.value.find(x => x.id === p.id);
                        if (s && s.currentPrice > 0) {
                            const newShares = p.amount / s.currentPrice;
                            s.cost = ((s.cost * s.shares) + p.amount) / (s.shares + newShares);
                            s.shares += newShares;
                        }
                    });
                    sipPending.value = [];
                };

                const handleModalSubmit = () => {
                    if (isEditing.value) {
                        const idx = stocks.value.findIndex(x => x.id === editingId.value);
                        stocks.value[idx] = { ...modalItem.value };
                    } else {
                        stocks.value.push({ ...modalItem.value, id: Date.now(), market: market.value });
                    }
                    showModal.value = false;
                };

                const openAddModal = () => { isEditing.value = false; modalItem.value = { name:'', symbol:'', cost:null, shares:null, currentPrice:null, isSIP:false, sipDay:10, sipAmount:5000 }; showModal.value = true; };
                const openEditModal = (s) => { isEditing.value = true; editingId.value = s.id; modalItem.value = { ...s }; showModal.value = true; };
                const removeStock = (s) => { if(confirm(`ç¢ºå®šåˆªé™¤ ${s.name}ï¼Ÿ`)) stocks.value = stocks.value.filter(x => x.id !== s.id); };
                
                const totalTWValue = computed(() => stocks.value.filter(s => s.market === 'å°è‚¡').reduce((sum, s) => sum + (s.currentPrice * s.shares), 0));
                const totalUSValueInTWD = computed(() => stocks.value.filter(s => s.market === 'ç¾è‚¡').reduce((sum, s) => sum + (s.currentPrice * s.shares), 0) * exchangeRate.value);
                const grandTotal = computed(() => totalTWValue.value + totalUSValueInTWD.value + (manualReserve.value || 0) + manualAssets.value.reduce((s, x) => s + (x.amount || 0), 0));
                const getRatio = (s) => (s.currentPrice * s.shares * (s.market==='ç¾è‚¡'?exchangeRate.value:1)) / (totalTWValue.value + totalUSValueInTWD.value) * 100;
                
                const marketStats = computed(() => {
                    const list = stocks.value.filter(s => s.market === market.value);
                    if (list.length === 0) return { profit: 0, ratio: 0 };
                    const tTotal = list.reduce((sum, s) => sum + (s.currentPrice * s.shares), 0);
                    const tCost = list.reduce((sum, s) => sum + (s.cost * s.shares), 0);
                    return { profit: ((tTotal / tCost) - 1) * 100, ratio: (tTotal * (market.value==='ç¾è‚¡'?exchangeRate.value:1)) / (totalTWValue.value + totalUSValueInTWD.value) * 100 };
                });

                const profitCalc = computed(() => {
                    if (selectedStockIdx.value === null) return {};
                    const s = stocks.value[selectedStockIdx.value];
                    const realized = (s.currentPrice - s.cost) * (s.shares / 2);
                    return { realized, stopPrice: s.currentPrice - (realized / s.shares) };
                });

                const totalReserve = computed(() => (monthlyEx.value * reserveMonths.value) + ((totalTWValue.value + totalUSValueInTWD.value) * reserveRatio.value));

                return { 
                    currentTab, market, stocks, showModal, isEditing, modalItem, openAddModal, openEditModal, handleModalSubmit, removeStock, usdMode, exchangeRate,
                    totalTWValue, totalUSValueInTWD, grandTotal, marketStats, getRatio, currentCurrencyLabel, formatMarketTotal, formatStockValue,
                    manualAssets, manualReserve, sipPending, confirmAllSIP, monthlyEx, reserveMonths, reserveRatio, selectedStockIdx, profitCalc, totalReserve
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
